name: Build Unbound static binary for Android arm64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Unbound source
        uses: actions/checkout@v4
        with:
          repository: NLnetLabs/unbound
          ref: release-1.21.0  # 你可以改成 master 或其他 tag，如 release-1.19.3 等

      - name: Download and setup Android NDK r21e
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
          unzip -q ndk.zip -d /opt
          mv /opt/android-ndk-r21e /opt/ndk
          echo "ANDROID_NDK_HOME=/opt/ndk" >> $GITHUB_ENV
          echo "/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Verify NDK toolchain
        run: |
          which aarch64-linux-android28-clang
          aarch64-linux-android28-clang --version

      - name: Build static OpenSSL 1.1.1w for Android arm64
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout OpenSSL_1_1_1w

          # workaround for some 1.1.1 tags missing fuzz dir
          rm -rf fuzz || true
          mkdir -p fuzz
          touch fuzz/build.info

          ./Configure android-arm64 \
            no-shared -static \
            no-asm no-tests \
            --prefix=/opt/openssl-android \
            --openssldir=/opt/openssl-android/ssl \
            -D__ANDROID_API__=28

          make depend
          make -j$(nproc) build_libs
          sudo make install_sw install_ssldirs

          ls -lh /opt/openssl-android/lib/libcrypto.a /opt/openssl-android/lib/libssl.a

      - name: Build static expat for Android arm64
        run: |
          git clone https://github.com/libexpat/libexpat.git
          cd libexpat/expat

          ./buildconf.sh

          ./configure --host=aarch64-linux-android \
            --prefix=/opt/expat-android \
            --disable-shared --enable-static \
            CC=aarch64-linux-android28-clang \
            CXX=aarch64-linux-android28-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            CFLAGS="-I/opt/openssl-android/include -O2 -fPIC" \
            LDFLAGS="-L/opt/openssl-android/lib -static"

          make -j$(nproc)
          sudo make install

      - name: Configure and build Unbound static for Android arm64
        run: |
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          ./configure --host=aarch64-linux-android \
            --prefix=/opt/unbound \
            --disable-shared --enable-static \
            --with-ssl=/opt/openssl-android \
            --with-libexpat=/opt/expat-android \
            --disable-flto --disable-rpath \
            CC=aarch64-linux-android28-clang \
            CXX=aarch64-linux-android28-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            CFLAGS="-I/opt/openssl-android/include -I/opt/expat-android/include -O2 -fPIC -ffunction-sections -fdata-sections" \
            LDFLAGS="-L/opt/openssl-android/lib -L/opt/expat-android/lib -static -Wl,--gc-sections"

          make -j$(nproc)

          # Strip to reduce size
          llvm-strip src/unbound

          # Verify it's static
          file src/unbound
          ldd src/unbound || true  # Should say not a dynamic executable

      - name: Upload unbound static binary
        uses: actions/upload-artifact@v4
        with:
          name: unbound-static-android-aarch64
          path: src/unbound
          if-no-files-found: error
