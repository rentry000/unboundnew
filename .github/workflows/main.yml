name: Build Unbound static for Android (aarch64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04   # 或 ubuntu-latest

    steps:
      - name: Checkout Unbound
        uses: actions/checkout@v4
        with:
          repository: NLnetLabs/unbound
          ref: release-1.21.0   # 改成你想要的 tag，例如 release-1.21.0 或 master

      - name: Install build essentials
        run: |
          sudo apt update
          sudo apt install -y git build-essential autoconf automake libtool pkg-config \
            bison flex perl make curl wget xz-utils bzip2
      - name: Cross-compile OpenSSL 1.1.1w static for Android arm64
        run: |
          # 下载 NDK r21e（兼容好，clang 命名稳定）
          wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
          unzip -q ndk.zip -d /opt
          mv /opt/android-ndk-r21e /opt/ndk
          export ANDROID_NDK_HOME=/opt/ndk
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
      
          # 调试：确认 clang 存在（会输出 aarch64-linux-android*-clang 等文件）
          ls $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/*clang*
      
          # Clone OpenSSL
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout OpenSSL_1_1_1w
      
          # workaround for fuzz dir (1.1.1 常见坑)
          rm -rf fuzz || true
          mkdir -p fuzz
          touch fuzz/build.info
      
          # 配置：让 Configure 自动用正确的 clang（不要手动 export CC）
          # 用 no-asm 避开 ARM 汇编问题（可选但推荐，手机 DNS 影响小）
          ./Configure android-arm64 \
            no-shared -static \
            no-asm no-tests \
            --prefix=/opt/openssl-android \
            --openssldir=/opt/openssl-android/ssl \
            -D__ANDROID_API__=28   # 或 21/23/34，根据 unbound 需求；28 兼容好
      
          # 构建库 + 安装
          make depend
          make -j$(nproc) build_libs   # 或 build_sw 如果需要完整
          make install_sw install_ssldirs
      
          # 验证静态库输出
          ls -lh /opt/openssl-android/lib/libcrypto.a /opt/openssl-android/lib/libssl.a

                
          
      - name: Build static expat for Android arm64 (NDK r21e)
        run: |
          git clone https://github.com/libexpat/libexpat.git
          cd libexpat/expat

          ./buildconf.sh

          # 使用 Actions 自带 NDK r27.3（无需下载，速度快）
          export NDK=/opt/ndk
          export SYSROOT=$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin

          # 关键修复：CC/CXX 必须带 --target 和 --sysroot
          export CC="$TOOLCHAIN/aarch64-linux-android28-clang --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export CXX="$TOOLCHAIN/aarch64-linux-android28-clang++ --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib

          ./configure --host=aarch64-linux-android \
            --build=x86_64-pc-linux-gnu \
            --prefix=/opt/expat-android \
            --disable-shared --enable-static \
            CFLAGS="-I/opt/openssl-android/include -O2 -fPIC --sysroot=$SYSROOT" \
            LDFLAGS="-L/opt/openssl-android/lib -static --sysroot=$SYSROOT -Wl,--gc-sections -fuse-ld=lld" \
            ac_cv_func_malloc_0_nonnull=yes \
            ac_cv_func_realloc_0_nonnull=yes

          make -j$(nproc)
          sudo make install

          # 如果失败自动打印 config.log（方便我继续帮你）
          if [ $? -ne 0 ]; then
            echo "===== CONFIGURE FAILED - showing config.log tail ====="
            tail -n 120 config.log
            exit 1
          fi

          ls -lh /opt/expat-android/lib/libexpat.a   # 验证成功
          

      - name: Configure & build Unbound static for Android arm64 (reallocarray patch fix)
        run: |
          export ANDROID_NDK_HOME=/opt/ndk
          export SYSROOT=$ANDROID_NDK_HOME/sysroot
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin

          export CC="$TOOLCHAIN/aarch64-linux-android28-clang --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export CXX="$TOOLCHAIN/aarch64-linux-android28-clang++ --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib
          export STRIP=$TOOLCHAIN/llvm-strip

          echo "=== Starting configure ==="

          ./configure --host=aarch64-linux-android \
            --build=x86_64-pc-linux-gnu \
            --prefix=/opt/unbound \
            --disable-shared --enable-static \
            --with-ssl=/opt/openssl-android \
            --with-libexpat=/opt/expat-android \
            --disable-flto --disable-rpath \
            CFLAGS="-I/opt/openssl-android/include -I/opt/expat-android/include -O2 -fPIC -Dreallocarray=my_reallocarray" \
            LDFLAGS="-static -Wl,--gc-sections -fuse-ld=lld \
                     -B$ANDROID_NDK_HOME/platforms/android-28/arch-arm64/usr/lib \
                     -L$ANDROID_NDK_HOME/platforms/android-28/arch-arm64/usr/lib" \
            ac_cv_func_reallocarray=no \
            ac_cv_func_malloc_0_nonnull=yes \
            ac_cv_func_realloc_0_nonnull=yes \
            ac_cv_prog_cc_c99=yes \
            ac_cv_prog_cc_cross=yes

          if [ $? -ne 0 ]; then
            tail -n 200 config.log
            exit 1
          fi

          echo "=== Configure 成功，开始 make + reallocarray patch ==="

          # 创建兼容实现文件
          cat > compat_reallocarray.c << 'EOF'
          #include <stdlib.h>
          #include <errno.h>

          void *my_reallocarray(void *ptr, size_t nmemb, size_t size) {
              size_t total;
              if (size == 0 || nmemb == 0) {
                  free(ptr);
                  return malloc(0);
              }
              if (nmemb > SIZE_MAX / size) {
                  errno = ENOMEM;
                  return NULL;
              }
              total = nmemb * size;
              return realloc(ptr, total);
          }
          EOF

          # 编译兼容文件
          $CC $CFLAGS -c compat_reallocarray.c -o compat_reallocarray.o

          # make
          make -j$(nproc)

          # 链接时加兼容对象文件（如果 make 还是报错，手动链接）
          if [ $? -ne 0 ]; then
            echo "make 失败，尝试手动链接 unbound"
            $CC $LDFLAGS src/*.o compat_reallocarray.o -o src/unbound -L/opt/openssl-android/lib -L/opt/expat-android/lib -lcrypto -lexpat -lpthread -lm -ldl
          fi

          $STRIP src/unbound || true

          echo "=== Build Result ==="
          file src/unbound || echo "unbound 未生成"
          ls -lh src/unbound || true
          # 调试：强制查找所有生成的文件
          echo "=== make 后文件搜索 ==="
          find . -name "*unbound*" -type f -executable -print 2>/dev/null || echo "没找到任何 unbound 可执行文件"
          ls -la src/ || true
          ls -la . || true

      - name: Upload all unbound binaries
        uses: actions/upload-artifact@v4
        with:
          name: unbound-static-android-aarch64
          path: |
            src/unbound
            unbound
            unbound-checkconf
            unbound-control
            unbound-host
          if-no-files-found: warn  # 改成 warn，不会让 workflow 失败
          
          
      - name: Commit and push binary to repo
        if: always()  # 即使失败也跑，方便调试
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 正确写法：用 ${{ secrets.GITHUB_TOKEN }}，不要加括号和空格
          git remote set-url origin https://x-access-token:\( {{ secrets.GITHUB_TOKEN }}@github.com/ \){{ github.repository }}.git

          git fetch origin
          git checkout main || git checkout -b main
          git pull origin main --rebase || true

          # 调试：打印所有文件，帮我们定位二进制
          echo "=== 当前目录文件列表 (ls -la) ==="
          ls -la

          echo "=== src/ 目录内容 ==="
          ls -la src/ || true

          echo "=== 查找所有 unbound 相关可执行文件 ==="
          find . -name "*unbound*" -type f -executable -print 2>/dev/null || echo "没找到任何 unbound* 文件"

          # 创建 binaries 目录
          mkdir -p binaries

          # 尝试复制所有可能的文件（如果找到就成功）
          cp src/unbound binaries/unbound-android-aarch64 2>/dev/null || true
          cp unbound binaries/unbound-android-aarch64 2>/dev/null || true
          cp unbound-checkconf binaries/unbound-checkconf 2>/dev/null || true
          cp unbound-control binaries/unbound-control 2>/dev/null || true

          # 如果复制成功，git add/commit/push
          if ls binaries/* 1> /dev/null 2>&1; then
            git add binaries/
            git commit -m "Add unbound static binaries for Android aarch64 (build ${{ github.run_number }}) - attempt ${{ github.run_attempt }}" || echo "No changes to commit"
            git push origin HEAD:main || echo "Push failed - 检查仓库权限或分支保护"
          else
            echo "没有复制到任何文件！请检查 make 是否生成二进制"
          fi
