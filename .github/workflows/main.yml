name: Build Unbound static for Android arm64 (NDK r27.3)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Unbound
        uses: actions/checkout@v4
        with:
          repository: NLnetLabs/unbound
          ref: release-1.21.0   # 可改成 master 或你想要的版本

      - name: Setup NDK r27.3 (Actions 自带，无需下载)
        run: |
          export NDK=/usr/local/lib/android/sdk/ndk/27.3.13750724
          echo "NDK=$NDK" >> $GITHUB_ENV
          echo "$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Verify NDK
        run: |
          aarch64-linux-android28-clang --version

      - name: Build static OpenSSL 1.1.1w
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout OpenSSL_1_1_1w

          rm -rf fuzz || true
          mkdir -p fuzz
          touch fuzz/build.info

          ./Configure android-arm64 \
            no-shared -static no-asm no-tests \
            --prefix=/opt/openssl-android \
            --openssldir=/opt/openssl-android/ssl \
            -D__ANDROID_API__=28

          make depend
          make -j$(nproc) build_libs
          sudo make install_sw install_ssldirs

          ls -lh /opt/openssl-android/lib/lib*.a

      - name: Build static expat (最终修复版)
        run: |
          git clone https://github.com/libexpat/libexpat.git
          cd libexpat/expat
          ./buildconf.sh

          export NDK=/usr/local/lib/android/sdk/ndk/27.3.13750724
          export SYSROOT=$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin

          export CC="$TOOLCHAIN/aarch64-linux-android28-clang --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export CXX="$TOOLCHAIN/aarch64-linux-android28-clang++ --target=aarch64-linux-android28 --sysroot=$SYSROOT"
          export AR=$TOOLCHAIN/llvm-ar
          export RANLIB=$TOOLCHAIN/llvm-ranlib

          ./configure --host=aarch64-linux-android \
            --build=x86_64-pc-linux-gnu \
            --prefix=/opt/expat-android \
            --disable-shared --enable-static \
            CFLAGS="-I/opt/openssl-android/include -O2 -fPIC --sysroot=$SYSROOT" \
            LDFLAGS="-L/opt/openssl-android/lib -static --sysroot=$SYSROOT -Wl,--gc-sections -fuse-ld=lld" \
            ac_cv_prog_cc_c99=yes \
            ac_cv_func_malloc_0_nonnull=yes \
            ac_cv_func_realloc_0_nonnull=yes

          make -j$(nproc)
          sudo make install

          ls -lh /opt/expat-android/lib/libexpat.a

      - name: Build Unbound static
        run: |
          export NDK=/usr/local/lib/android/sdk/ndk/27.3.13750724
          export SYSROOT=$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin

          ./configure --host=aarch64-linux-android \
            --prefix=/opt/unbound \
            --disable-shared --enable-static \
            --with-ssl=/opt/openssl-android \
            --with-libexpat=/opt/expat-android \
            --disable-flto --disable-rpath \
            CC="$TOOLCHAIN/aarch64-linux-android28-clang --target=aarch64-linux-android28 --sysroot=$SYSROOT" \
            CXX="$TOOLCHAIN/aarch64-linux-android28-clang++ --target=aarch64-linux-android28 --sysroot=$SYSROOT" \
            AR=$TOOLCHAIN/llvm-ar \
            RANLIB=$TOOLCHAIN/llvm-ranlib \
            STRIP=$TOOLCHAIN/llvm-strip \
            CFLAGS="-I/opt/openssl-android/include -I/opt/expat-android/include -O2 -fPIC --sysroot=$SYSROOT" \
            LDFLAGS="-L/opt/openssl-android/lib -L/opt/expat-android/lib -static --sysroot=$SYSROOT -Wl,--gc-sections"

          make -j$(nproc)
          $TOOLCHAIN/llvm-strip src/unbound

          file src/unbound
          echo "=== 二进制大小 ==="
          ls -lh src/unbound

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unbound-static-android-arm64
          path: src/unbound
