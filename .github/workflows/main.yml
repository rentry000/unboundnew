name: Build Unbound static for Android (aarch64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04   # 或 ubuntu-latest

    steps:
      - name: Checkout Unbound
        uses: actions/checkout@v4
        with:
          repository: NLnetLabs/unbound
          ref: release-1.21.0   # 改成你想要的 tag，例如 release-1.21.0 或 master

      - name: Install build essentials
        run: |
          sudo apt update
          sudo apt install -y git build-essential autoconf automake libtool pkg-config \
            bison flex perl make curl wget xz-utils bzip2
      - name: Cross-compile OpenSSL 1.1.1w static for Android arm64
        run: |
          # 下载 NDK r21e（兼容好，clang 命名稳定）
          wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
          unzip -q ndk.zip -d /opt
          mv /opt/android-ndk-r21e /opt/ndk
          export ANDROID_NDK_HOME=/opt/ndk
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
      
          # 调试：确认 clang 存在（会输出 aarch64-linux-android*-clang 等文件）
          ls $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/*clang*
      
          # Clone OpenSSL
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout OpenSSL_1_1_1w
      
          # workaround for fuzz dir (1.1.1 常见坑)
          rm -rf fuzz || true
          mkdir -p fuzz
          touch fuzz/build.info
      
          # 配置：让 Configure 自动用正确的 clang（不要手动 export CC）
          # 用 no-asm 避开 ARM 汇编问题（可选但推荐，手机 DNS 影响小）
          ./Configure android-arm64 \
            no-shared -static \
            no-asm no-tests \
            --prefix=/opt/openssl-android \
            --openssldir=/opt/openssl-android/ssl \
            -D__ANDROID_API__=28   # 或 21/23/34，根据 unbound 需求；28 兼容好
      
          # 构建库 + 安装
          make depend
          make -j$(nproc) build_libs   # 或 build_sw 如果需要完整
          make install_sw install_ssldirs
      
          # 验证静态库输出
          ls -lh /opt/openssl-android/lib/libcrypto.a /opt/openssl-android/lib/libssl.a

                
          
      - name: Build static expat for Android arm64 (NDK r27+ fix)
        run: |
          git clone https://github.com/libexpat/libexpat.git
          cd libexpat/expat

          ./buildconf.sh

          # NDK r27+ 的 sysroot 路径（统一确认）
          export SYSROOT=$ANDROID_NDK_HOME/sysroot
          export NDK_TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64

          # 显式定义所有工具（避免 PATH 问题）
          export CC=$NDK_TOOLCHAIN/bin/aarch64-linux-android28-clang
          export CXX=$NDK_TOOLCHAIN/bin/aarch64-linux-android28-clang++
          export AR=$NDK_TOOLCHAIN/bin/llvm-ar
          export RANLIB=$NDK_TOOLCHAIN/bin/llvm-ranlib
          export LD=$NDK_TOOLCHAIN/bin/ld.lld   # NDK r25+ 推荐 lld 链接器

          # 配置（关键：--with-sysroot + --sysroot 到 flags）
          ./configure --host=aarch64-linux-android \
            --build=x86_64-pc-linux-gnu \
            --prefix=/opt/expat-android \
            --disable-shared --enable-static \
            --with-sysroot=$SYSROOT \
            CC="$CC --sysroot=$SYSROOT" \
            CXX="$CXX --sysroot=$SYSROOT" \
            CFLAGS="-I/opt/openssl-android/include -O2 -fPIC --sysroot=$SYSROOT" \
            LDFLAGS="-L/opt/openssl-android/lib -L$SYSROOT/usr/lib/aarch64-linux-android -static --sysroot=$SYSROOT -Wl,--gc-sections -fuse-ld=lld"

          make -j$(nproc)
          sudo make install

          # 如果 configure 失败，强制打印 config.log 关键部分
          if [ $? -ne 0 ]; then
            echo "===== Configure failed! config.log tail ====="
            tail -n 80 config.log | grep -i -e error -e cannot -e undefined -e crt -e ld: || cat config.log | tail -n 50
            exit 1
          fi
          

      - name: Setup musl cross toolchain (aarch64)
        run: |
          wget https://musl.cc/aarch64-linux-musl-cross.tgz
          tar xzf aarch64-linux-musl-cross.tgz
          sudo mv aarch64-linux-musl-cross /opt/
          echo "/opt/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH

      - name: Configure & build Unbound static
        run: |
          cd $GITHUB_WORKSPACE
          ./configure --host=aarch64-linux-musl \
            --prefix=/opt/unbound \
            --disable-shared --enable-static \
            --with-ssl=/opt/openssl-aarch64 \
            --with-libexpat=/opt/expat-aarch64 \
            --disable-flto --disable-rpath \
            CC=aarch64-linux-musl-gcc \
            CFLAGS="-I/opt/openssl-aarch64/include -I/opt/expat-aarch64/include -Os -ffunction-sections -fdata-sections" \
            LDFLAGS="-L/opt/openssl-aarch64/lib64 -L/opt/expat-aarch64/lib -static -Wl,--gc-sections"

          make -j$(nproc)
          make install DESTDIR=$GITHUB_WORKSPACE/artifacts

      - name: Strip binary (make it smaller)
        run: |
          aarch64-linux-musl-strip $GITHUB_WORKSPACE/artifacts/opt/unbound/sbin/unbound
          aarch64-linux-musl-strip $GITHUB_WORKSPACE/artifacts/opt/unbound/bin/unbound-control 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unbound-static-android-aarch64
          path: |
            artifacts/opt/unbound/sbin/unbound
            artifacts/opt/unbound/bin/unbound-*
            artifacts/opt/unbound/etc/unbound/unbound.conf

      - name: Show binary size
        run: ls -lh artifacts/opt/unbound/sbin/unbound
